# Project Aira: í†µí•© ê°€ì´ë“œ (News Agent with Tool Calling)

ì´ ê°€ì´ë“œëŠ” `aira_main.py`ì— **ë‰´ìŠ¤ ì—ì´ì „íŠ¸(NewsAgent)**ë¥¼ í†µí•©í•˜ê³ , **ë„êµ¬ í˜¸ì¶œ(Tool Calling)** ê¸°ëŠ¥ì„ í™œì„±í™”í•˜ê¸° ìœ„í•œ ì ˆì°¨ì…ë‹ˆë‹¤.
ì´ì œ Geminiê°€ ëŒ€í™” ë§¥ë½ì„ íŒŒì•…í•˜ê³  ìŠ¤ìŠ¤ë¡œ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

---

## 1. Import ì¶”ê°€ (íŒŒì¼ ìƒë‹¨)

`aira_main.py`ì˜ ê°€ì¥ ìœ„ìª½ import ì„¹ì…˜ì— ì•„ë˜ ì½”ë“œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.

```python
# [NEW] ëª¨ë“ˆ ë§¤ë‹ˆì € ë° ë‰´ìŠ¤ ì—ì´ì „íŠ¸ ê°€ì ¸ì˜¤ê¸°
from backend.module_manager import ModuleManager
from backend.modules.news_agent import NewsAgent
from google.genai.types import Tool, FunctionDeclaration, ToolCode
```

---

## 2. ëª¨ë“ˆ ì´ˆê¸°í™” (gemini_worker í•¨ìˆ˜ ë‚´ë¶€)

`gemini_worker()` í•¨ìˆ˜ ì‹œì‘ ë¶€ë¶„ì— ëª¨ë“ˆ ë§¤ë‹ˆì €ë¥¼ ìƒì„±í•˜ê³  ë‰´ìŠ¤ ì—ì´ì „íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.

```python
async def gemini_worker():
    print("[Gemini] Worker started.")

    # [NEW] ëª¨ë“ˆ ë§¤ë‹ˆì € ì´ˆê¸°í™” ë° ë‰´ìŠ¤ ì—ì´ì „íŠ¸ ë“±ë¡
    module_manager = ModuleManager()
    module_manager.register_module(NewsAgent())

    client = genai.Client(api_key=API_KEY)
    
    # [NEW] ë„êµ¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
    tools_def = module_manager.get_all_tools()
    
    config = {
        "response_modalities": ["AUDIO"],
        "speech_config": {
            "voice_config": {"prebuilt_voice_config": {"voice_name": "Aoede"}}
        },
        # [NEW] ë„êµ¬ ë“±ë¡
        "tools": tools_def
    }
```

---

## 3. ì„¸ì…˜ ì—°ê²° ë° ì—…ë°ì´íŠ¸ ë£¨í”„ (receive_loop ë‚´ë¶€ ìˆ˜ì •)

`receive_loop` í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ Geminiê°€ ë³´ë‚´ëŠ” **ë„êµ¬ í˜¸ì¶œ ìš”ì²­(FunctionCall)**ì„ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.

```python
                async def receive_loop():
                    while True:
                        try:
                            # [MODIFY] receive() ë£¨í”„ì—ì„œ ë„êµ¬ í˜¸ì¶œ ì²˜ë¦¬ ì¶”ê°€
                            async for response in session.receive():
                                server_content = response.server_content
                                if server_content is None:
                                    continue
                                    
                                model_turn = server_content.model_turn
                                if model_turn:
                                    for part in model_turn.parts:
                                        # 1. ì˜¤ë””ì˜¤/í…ìŠ¤íŠ¸ ì‘ë‹µ ì²˜ë¦¬ (ê¸°ì¡´ ì½”ë“œ)
                                        if part.inline_data:
                                            output_q.put(part.inline_data.data)
                                        if part.text:
                                            print(part.text, end="")

                                        # [NEW] 2. ë„êµ¬ í˜¸ì¶œ(Function Call) ì²˜ë¦¬
                                        if part.function_call:
                                            print(f"\n[Gemini] ğŸ› ï¸ Tool Call: {part.function_call.name}")
                                            
                                            # ëª¨ë“ˆ ë§¤ë‹ˆì €ì—ê²Œ ì‹¤í–‰ ìœ„ì„
                                            # handle_tool_callì€ {'name': ..., 'content': ...} ë°˜í™˜
                                            # ToolCall ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë„˜ê¸°ê¸° ìœ„í•´ part êµ¬ì¡°ì— ë§ì¶° í˜¸ì¶œ
                                            # (ì£¼ì˜: handle_tool_call êµ¬í˜„ì— ë”°ë¼ ì¸ì ì¡°ì • í•„ìš”)
                                            # ì—¬ê¸°ì„œëŠ” part ìì²´ë¥¼ ë„˜ê²¨ ì¶”ì¶œí•˜ë„ë¡ ê°€ì •í•˜ê±°ë‚˜, ì§ì ‘ ì¸ì ì¶”ì¶œ
                                            
                                            # ê°„ë‹¨í•˜ê²Œ part.function_callì„ ë„˜ê²¨ì„œ ì²˜ë¦¬í•œë‹¤ê³  ê°€ì • (module_manager ìˆ˜ì • í•„ìš”ì‹œ ë°˜ì˜)
                                            # ì‹¤ì œë¡œëŠ” module_manager.handle_tool_callì´ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬í•˜ë„ë¡ í•¨
                                            
                                            # ì„ì‹œ: ì§ì ‘ í˜¸ì¶œ êµ¬ì¡°ì— ë§ê²Œ ë³€í™˜
                                            class MockToolCall: # ì„ì‹œ ë˜í¼ (êµ¬ì¡° ë§ì¶”ê¸°ìš©)
                                                 def __init__(self, fc): self.function_calls = [fc]
                                                 
                                            tool_result = await module_manager.handle_tool_call(MockToolCall(part.function_call))
                                            
                                            if tool_result:
                                                # ê²°ê³¼ë¥¼ Geminiì—ê²Œ ì „ì†¡ (tool_response)
                                                await session.send(
                                                    input=tool_result, # {'name':..., 'content':...}
                                                    end_of_turn=True
                                                )
                                                print(f"[Gemini] ğŸ“¤ Tool Response Sent")

                                if server_content.turn_complete:
                                    # í„´ ì¢…ë£Œ ì²˜ë¦¬
                                    pass

                        except Exception as e:
                            print(f"[Receive Error] {e}")
                            break
                        
                        if shutdown_event.is_set(): break
```

> **ì£¼ì˜**: `module_manager.py`ì˜ `handle_tool_call`ì€ `tool_call.function_calls` (ë¦¬ìŠ¤íŠ¸)ë¥¼ ê¸°ëŒ€í•˜ë„ë¡ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
> `receive_loop`ì—ì„œ `part.function_call`ì€ ë‹¨ì¼ ê°ì²´ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì´ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ê°ì‹¸ì„œ `handle_tool_call`ì— ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
> ìœ„ ì˜ˆì‹œ ì½”ë“œì˜ `MockToolCall` ë¶€ë¶„ì²˜ëŸ¼ ê°ì‹¸ì„œ ì „ë‹¬í•´ì£¼ì„¸ìš”.

---

## 4. ì—…ë°ì´íŠ¸ ë£¨í”„ (Session Context ë‚´ë¶€)

ë§ˆì§€ë§‰ìœ¼ë¡œ ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ë£¨í”„ë„ ìŠì§€ ë§ê³  ì¶”ê°€í•˜ì„¸ìš” (`asyncio.gather`ì— í¬í•¨).

```python
                # [NEW] ì£¼ê¸°ì  ì—…ë°ì´íŠ¸ ë£¨í”„ (ë‰´ìŠ¤ ìë™ ì²´í¬ìš©)
                async def update_loop():
                    while True:
                        try:
                            if shutdown_event.is_set(): break
                            await module_manager.run_updates() # ëª¨ë“ˆë³„ ë°±ê·¸ë¼ìš´ë“œ ì‘ì—…
                            await asyncio.sleep(1)
                        except Exception:
                            await asyncio.sleep(5)

                # [MODIFY] run all loops
                await asyncio.gather(send_loop(), receive_loop(), update_loop())
```
